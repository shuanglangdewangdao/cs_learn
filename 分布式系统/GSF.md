# 分布式存储系统

## 难度

出发点是性能->并行读取数据（分片->错误->容错性->备份->不一致性问题->一致性->低性能

## 问题：糟糕的备份设计

1. 没有限定服务器的执行顺序

## GSF

### 目标

1. 大容量，高速度
2. 全局可复用
3. 文件拆分
4. 自动恢复

### 条件

1. 单数据中心
2. 内部使用
3. 大数据连续访问

### 论文要点

1. 超大型集群
2. 弱一致性
3. 单个master节点

### Master 节点

文件名->块标识符（非易失性）

块标识符->数据副本位置(易失性)
块标识符->每个的版本号(非易失性)
块标识符->首选副本(易失性)
块标识符->数据lease过期时间(易失性)：保证同一时间只有一个首选副本

操作即记录日志，并建立检查点

#### 使用日志文件的好处

本身采用B树实现，添加更快，读取时能迅速找到最后一个检查点

### 读操作

1. 文件名+偏移量(某个文件位置)->Master
2. Master—>H，L-Client(cache)
3. 客户端与对应服务器通信获得相应数据

### 写操作

#### 记录追加

##### 没有首选副本

1. 找出最新的副本呢（根据版本号）
2. Master选定首选副本
3. 给首选chunk新的版本号（设定过期时间）
4. Master写下新的版本号
5. Master告知客户端对应的首选副本，辅助副本
6. 首选副本与客户端通信直到完成写操作

### 更强的一致性

1. 请求的重复检测
2. 执行错误的补偿机制（重复请求，退出错误备份。。。）
3. 更详细的写操作
4. 首选副本执行中崩溃，新的首选副本要重新显示同步

## 备份

fail-stop:出错后计算机停止运行(不包括软件bug，随机硬件错误)

备份的错误时不相干的

### 备份方法

#### 状态转移

将执行状态发送给备机

更适合多核机器

#### 备份状态机

只发送外部事件到备机

不支持多核机器
#### 状态

备份所有内存

GSF只复制当前的块标识符

状态可能不是不确定的例如随机数的生成

1. 输入：到达和中断事件主备不同
2. 指令：随机数的生成，cpuid
3. 多核并行：指令执行顺序不确定

log entry（主备通信用）：指令号，类型，数据（处理随机事件）

##### VMware FT

数据包的传递

备机的执行绝不会超过主机

只有主机收到备机回复才会输出

网络故障让备机认为主机宕机问题：外部权威服务器

#### 主备同步

#### 故障切换

#### 应对切换异常

#### 新的备机